<!DOCTYPE html>
<html lang="vi">
	<head>
		<meta charset="UTF-8" />
		<title>Lofi Music</title>
		<!-- Th√™m Tailwind CSS -->
		<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
	</head>
	<body class="bg-gray-800 text-white font-sans text-center p-5">
		<h1 class="text-3xl font-bold mb-6 flex items-center justify-center space-x-3 text-gray-100">
			<span>üéß</span>
			<span>Tr√¨nh Nghe Nh·∫°c</span>
		</h1>

		<div class="mb-5 flex flex-row justify-center items-center space-x-2">
			<button onclick="playNext()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">Ti·∫øp theo</button>
			<button onclick="toggleRepeat()" id="repeatBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">L·∫∑p l·∫°i: <span id="repeatStatus">T·∫Øt</span></button>
			<button onclick="toggleRandom()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition">Ch·∫ø ƒë·ªô: <span id="mode">Ng·∫´u nhi√™n</span></button>
		</div>

		<!-- Player: Container ch·ª© kh√¥ng d√πng video c·ªë ƒë·ªãnh -->
		<div id="playerContainer" class="w-full max-w-lg mx-auto rounded-lg bg-black overflow-hidden"></div>

		<div id="currentSong" class="mt-4 flex items-center justify-center space-x-3 text-lg bg-gray-700 p-3 rounded-xl shadow-lg max-w-md mx-auto"></div>

		<!-- N√∫t ·∫©n/hi·ªán playlist -->
		<button id="togglePlaylistBtn" class="mt-4 mb-2 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition">·∫®n playlist</button>

		<button onclick="saveForOffline(currentIndex)" id="saveOfflineBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition">
			<span id="saveStatus">L∆∞u ƒë·ªÉ nghe offline</span>
		</button>

		<!-- B·ªçc playlist v√† ph√¢n trang -->
		<div id="playlistWrapper">
			<ul id="playlist" class="mt-6 max-w-lg mx-auto bg-gray-700 rounded-lg shadow divide-y divide-gray-600 text-left"></ul>
			<div id="pagination" class="flex justify-center items-center space-x-2 mt-4"></div>
		</div>

		<script>
			// Kh·ªüi t·∫°o IndexedDB
			let db;
			const request = indexedDB.open("MusicDB", 1);

			request.onerror = (event) => {
				console.error("L·ªói khi m·ªü database:", event.target.error);
			};

			request.onupgradeneeded = (event) => {
				db = event.target.result;
				if (!db.objectStoreNames.contains("offlineMusic")) {
					const store = db.createObjectStore("offlineMusic", { keyPath: "id" });
					store.createIndex("name", "name", { unique: false });
					store.createIndex("url", "url", { unique: true });
				}
			};

			request.onsuccess = (event) => {
				db = event.target.result;
				checkOfflineStatus();
			};

			// Ki·ªÉm tra tr·∫°ng th√°i offline c·ªßa b√†i h√°t
			function checkOfflineStatus() {
				const tx = db.transaction(["offlineMusic"], "readonly");
				const store = tx.objectStore("offlineMusic");
				const request = store.getAll();

				request.onsuccess = (event) => {
					const offlineSongs = event.target.result;
					const currentSong = musicList[currentIndex];

					// C·∫≠p nh·∫≠t n√∫t l∆∞u
					const isSaved = offlineSongs.some((song) => song.url === currentSong);
					document.getElementById("saveStatus").textContent = isSaved ? "ƒê√£ l∆∞u" : "L∆∞u ƒë·ªÉ nghe offline";
				};
			}

			// L∆∞u b√†i h√°t ƒë·ªÉ nghe offline
			async function saveForOffline(index) {
				const url = musicList[index];
				const name = songNames[index];

				// Ki·ªÉm tra xem b√†i h√°t ƒë√£ ƒë∆∞·ª£c l∆∞u ch∆∞a
				const tx = db.transaction(["offlineMusic"], "readonly");
				const store = tx.objectStore("offlineMusic");
				const request = store.get(url);

				request.onsuccess = async (event) => {
					if (event.target.result) {
						alert("B√†i h√°t ƒë√£ ƒë∆∞·ª£c l∆∞u!");
						return;
					}

					// T·∫£i file v√† l∆∞u v√†o IndexedDB
					try {
						const response = await fetch(url);
						const blob = await response.blob();
						const file = new File([blob], name + "." + url.split(".").pop());

						const saveTx = db.transaction(["offlineMusic"], "readwrite");
						const saveStore = saveTx.objectStore("offlineMusic");

						const saveRequest = saveStore.add({
							id: Date.now(),
							name: name,
							url: url,
							blob: file,
						});

						saveRequest.onsuccess = () => {
							alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
							checkOfflineStatus();
						};

						saveRequest.onerror = () => {
							console.error("L·ªói khi l∆∞u b√†i h√°t:", saveRequest.error);
							alert("L·ªói khi l∆∞u b√†i h√°t!");
						};
					} catch (error) {
						console.error("L·ªói khi t·∫£i file:", error);
						alert("Kh√¥ng th·ªÉ t·∫£i file!");
					}
				};
			}

			// Ph√°t b√†i h√°t offline
			function playOffline(url) {
				const tx = db.transaction(["offlineMusic"], "readonly");
				const store = tx.objectStore("offlineMusic");
				const request = store.get(url);

				request.onsuccess = (event) => {
					const song = event.target.result;
					if (song) {
						// T·∫°o URL t·ª´ blob
						const blobUrl = URL.createObjectURL(song.blob);

						// T·∫°o v√† ph√°t video/audio
						const video = document.createElement("video");
						video.src = blobUrl;
						video.controls = true;
						video.playsInline = true;
						video.autoplay = true;
						video.className = "w-full";
						video.volume = 0.5;

						playerContainer.innerHTML = "";
						playerContainer.appendChild(video);

						// X√≥a URL khi kh√¥ng c·∫ßn thi·∫øt
						video.addEventListener("ended", () => URL.revokeObjectURL(blobUrl));
					} else {
						alert("Kh√¥ng t√¨m th·∫•y b√†i h√°t trong b·ªô nh·ªõ offline!");
						// Th·ª≠ ph√°t t·ª´ ngu·ªìn tr·ª±c tuy·∫øn
						play(currentIndex);
					}
				};
			}

			// Ki·ªÉm tra v√† c·∫≠p nh·∫≠t playlist
			function updatePlaylistWithOfflineStatus() {
				const tx = db.transaction(["offlineMusic"], "readonly");
				const store = tx.objectStore("offlineMusic");
				const request = store.getAll();

				request.onsuccess = (event) => {
					const offlineSongs = event.target.result;
					const playlistItems = document.querySelectorAll("#playlist li");

					playlistItems.forEach((item) => {
						const index = Array.from(playlistItems).indexOf(item);
						const url = musicList[index];
						const isOffline = offlineSongs.some((song) => song.url === url);

						if (isOffline) {
							item.classList.add("bg-green-600", "text-white");
						} else {
							item.classList.remove("bg-green-600", "text-white");
						}
					});
				};
			}

			// Ki·ªÉm tra k·∫øt n·ªëi v√† c·∫≠p nh·∫≠t giao di·ªán
			function checkConnectionStatus() {
				if (!navigator.onLine) {
					document.body.classList.add("offline-mode");
					document.getElementById("saveOfflineBtn").disabled = true;
				} else {
					document.body.classList.remove("offline-mode");
					document.getElementById("saveOfflineBtn").disabled = false;
				}
			}

			// Ki·ªÉm tra k·∫øt n·ªëi khi t·∫£i trang
			window.addEventListener("load", checkConnectionStatus);
			// Ki·ªÉm tra khi thay ƒë·ªïi tr·∫°ng th√°i k·∫øt n·ªëi
			window.addEventListener("online", checkConnectionStatus);
			window.addEventListener("offline", checkConnectionStatus);

			// Th√™m style cho ch·∫ø ƒë·ªô offline
			document.head.insertAdjacentHTML(
				"beforeend",
				`
        <style>
            .offline-mode {
                --tw-bg-opacity: 1;
                background-color: rgba(255, 255, 255, var(--tw-bg-opacity));
            }
            .offline-mode .bg-gray-800 {
                --tw-bg-opacity: 0.9;
                background-color: rgba(31, 41, 55, var(--tw-bg-opacity));
            }
        </style>
    `
			);
			const musicList = [
				"music/1.mp3",
				"music/2.mp3",
				"music/3.mp3",
				"music/4.mp3",
				"music/5.mp3",
				"music/6.mp3",
				"music/7.mp3",
				"music/8.mp3",
				"music/9.mp3",
				"music/10.mp3",
				"music/11.mp3",
				"music/12.mp3",
				"music/13.mp3",
				"music/14.mp3",
				"music/15.mp3",
				"music/16.mp3",
				"music/17.mp3",
				"music/18.mp3",
				"music/19.mp3",
				"music/20.mp3",
				"music/21.mp3",
				"music/22.mp3",
				"music/24.mp3",
				"music/25.mp3",
				"music/26.mp3",
				"music/27.mp3",
				"music/28.mp3",
				"music/29.mp3",
				"music/30.mp3",
				"music/31.mp3",
				"music/32.mp3",
				"music/33.mp3",
				// Th√™m link YouTube v√≠ d·ª•:
				"https://www.youtube.com/embed/lqFGzPM8wkg",
				"https://www.youtube.com/embed/xi1cWsfJTTs",
				"https://www.youtube.com/embed/uXkYCdL_HpY",
			];

			const songNames = [
				"Th√°p R∆°i T·ª± Do",
				"Gh√©p H√¨nh T√¨nh Y√™u",
				"G√≥p Vui",
				"Kiss Kiss Shy Shy",
				"Nh∆∞",
				"B·∫•t C√¥ng",
				"CocoCoCo",
				"Magnetic",
				"S∆°n H·∫£i",
				"Nh·∫≠p Ho√†i",
				"Kh√¥ng N·ª° - ƒê·∫•u La ƒê·∫°i L·ª•c",
				"C√≥ - Kh√¥ng C√≥",
				"ƒê·ªëi Di·ªán",
				"Tham C·∫ßu - Th·∫ßn ·∫®n",
				"Ring Ring Ring",
				"TA - B√†n H·ªï",
				"Nh∆∞ Ca - Li·ªát H·ªèa Nh∆∞ Ca",
				"C√°i ƒêu√¥i Nh·ªè",
				"L∆∞u Chuy·ªÉn Doanh H·ªìi - Ng·ªô Long",
				"ƒê√¥ng Mi√™n",
				"Polaroid Love",
				"For ya ‚Äì T∆∞·ªüng Ti·ªÉu Ni",
				"Say YES",
				"Ch·ªù ƒê·∫øn Th√°ng 13",
				"M√¨nh C√πng Nhau ƒê√≥ng BƒÉng",
				"Trang Gi·∫•y Cu·ªëi C√πng",
				"Blueming - IU",
				"Y√™u Nh∆∞ Th·∫ø - Th·∫ßn ·∫®n",
				"B√≠ch Th∆∞∆°ng Chi·∫øn Ca - D·ªØ Ph∆∞·ª£ng H√†nh",
				"Phong - Thi·∫øu Ni√™n Ca H√†nh",
				"D·ªØ Qu√¢n Quy - R·∫•t Nh·ªõ R·∫•t Nh·ªõ Anh",
				"Ch∆∞a Ch·∫Øc - Ng√¥ C·∫©n Ng√¥n",
				// T√™n b√†i cho YouTube link
				"H·ªçc b√†i v√† nghe nh·∫°c c√πng t·ªõ nh√©",
				"D·ªØ Ph∆∞·ª£ng H√†nh OST",
				"Playlist Nh·∫°c H√®",
			];

			let currentIndex = 0;
			let isRandom = true;
			let currentPage = 1;
			const pageSize = 10;

			const playerContainer = document.getElementById("playerContainer");
			const modeSpan = document.getElementById("mode");
			const currentSongDisplay = document.getElementById("currentSong");
			const playlist = document.getElementById("playlist");

			function renderPlaylist() {
				playlist.innerHTML = "";
				const start = (currentPage - 1) * pageSize;
				const end = Math.min(start + pageSize, songNames.length);

				for (let idx = start; idx < end; idx++) {
					const name = songNames[idx];
					const url = musicList[idx];
					let icon = "üéµ";
					if (url.includes("youtube.com") || url.includes("youtu.be")) {
						icon = "‚ñ∂Ô∏è";
					} else if (url.endsWith(".mp3")) {
						icon = "üé∂";
					} else if (url.endsWith(".mp4")) {
						icon = "üé¨";
					}

					const li = document.createElement("li");
					li.textContent = `${icon} ${name}`;
					li.className = "cursor-pointer px-4 py-2 hover:bg-gray-600 transition" + (idx === currentIndex ? " bg-gray-500 font-bold" : "");
					li.onclick = () => {
						currentIndex = idx;
						play(currentIndex);
						renderPlaylist();
					};
					playlist.appendChild(li);
				}

				renderPagination();
			}

			function renderPagination() {
				const pagination = document.getElementById("pagination");
				pagination.innerHTML = "";
				const totalPages = Math.ceil(songNames.length / pageSize);

				// N√∫t Prev
				const prevBtn = document.createElement("button");
				prevBtn.textContent = "¬´";
				prevBtn.disabled = currentPage === 1;
				prevBtn.className = "px-2 py-1 rounded bg-gray-600 hover:bg-gray-500 disabled:opacity-50";
				prevBtn.onclick = () => {
					if (currentPage > 1) {
						currentPage--;
						renderPlaylist();
					}
				};
				pagination.appendChild(prevBtn);

				// Hi·ªÉn th·ªã s·ªë trang
				for (let i = 1; i <= totalPages; i++) {
					const pageBtn = document.createElement("button");
					pageBtn.textContent = i;
					pageBtn.className = "px-2 py-1 rounded " + (i === currentPage ? "bg-blue-500 text-white" : "bg-gray-600 hover:bg-gray-500");
					pageBtn.onclick = () => {
						currentPage = i;
						renderPlaylist();
					};
					pagination.appendChild(pageBtn);
				}

				// N√∫t Next
				const nextBtn = document.createElement("button");
				nextBtn.textContent = "¬ª";
				nextBtn.disabled = currentPage === totalPages;
				nextBtn.className = "px-2 py-1 rounded bg-gray-600 hover:bg-gray-500 disabled:opacity-50";
				nextBtn.onclick = () => {
					if (currentPage < totalPages) {
						currentPage++;
						renderPlaylist();
					}
				};
				pagination.appendChild(nextBtn);
			}

			function play(index) {
				const url = musicList[index];
				// T·ª± ƒë·ªông chuy·ªÉn trang ch·ª©a b√†i h√°t ƒëang ph√°t
				currentPage = Math.floor(index / pageSize) + 1;

				playerContainer.innerHTML = ""; // X√≥a n·ªôi dung player c≈©

				if (url.includes("youtube.com") || url.includes("youtu.be")) {
					// Link YouTube
					const iframe = document.createElement("iframe");
					iframe.src = url + "?autoplay=1";
					iframe.width = "100%";
					iframe.height = "315";
					iframe.frameBorder = "0";
					iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
					iframe.allowFullscreen = true;
					playerContainer.appendChild(iframe);
				} else {
					// File mp3/mp4
					const video = document.createElement("video");
					video.src = url;
					video.controls = true;
					video.playsInline = true;
					video.autoplay = true;
					video.className = "w-full";
					video.volume = 0.5;
					video.addEventListener("ended", function () {
						if (isRepeat) {
							play(currentIndex); // Ph√°t l·∫°i b√†i hi·ªán t·∫°i
						} else {
							playNext();
						}
					});
					playerContainer.appendChild(video);
				}

				// X√°c ƒë·ªãnh icon theo lo·∫°i file
				let icon = "üéµ";
				if (url.includes("youtube.com") || url.includes("youtu.be")) {
					icon = "‚ñ∂Ô∏è";
				} else if (url.endsWith(".mp3")) {
					icon = "üé∂";
				} else if (url.endsWith(".mp4")) {
					icon = "üé¨";
				}

				// C·∫≠p nh·∫≠t n·ªôi dung "ƒêang ph√°t"
				currentSongDisplay.innerHTML = `<span class="text-2xl">${icon}</span> <span>${songNames[index]}</span>`;

				renderPlaylist();
			}
			let isRepeat = false;

			function toggleRepeat() {
				isRepeat = !isRepeat;
				document.getElementById("repeatStatus").textContent = isRepeat ? "B·∫≠t" : "T·∫Øt";
			}
			function playNext() {
				if (isRandom) {
					let nextIndex;
					const nonYoutubeIndexes = musicList.map((item, idx) => (!item.includes("youtube.com") && !item.includes("youtu.be") ? idx : -1)).filter((idx) => idx !== -1);

					do {
						const randomPos = Math.floor(Math.random() * nonYoutubeIndexes.length);
						nextIndex = nonYoutubeIndexes[randomPos];
					} while (nonYoutubeIndexes.length > 1 && nextIndex === currentIndex);

					currentIndex = nextIndex;
				} else {
					currentIndex = (currentIndex + 1) % musicList.length;
				}
				play(currentIndex);
			}

			function toggleRandom() {
				isRandom = !isRandom;
				modeSpan.textContent = isRandom ? "Ng·∫´u nhi√™n" : "Tu·∫ßn t·ª±";
			}

			// ·∫®n/hi·ªán playlist
			const playlistWrapper = document.getElementById("playlistWrapper");
			const togglePlaylistBtn = document.getElementById("togglePlaylistBtn");
			let isPlaylistVisible = false; // M·∫∑c ƒë·ªãnh ·∫©n

			// ·∫®n playlist khi m·ªü trang
			playlistWrapper.style.display = "none";
			togglePlaylistBtn.textContent = "Hi·ªán playlist";

			togglePlaylistBtn.onclick = function () {
				isPlaylistVisible = !isPlaylistVisible;
				playlistWrapper.style.display = isPlaylistVisible ? "block" : "none";
				togglePlaylistBtn.textContent = isPlaylistVisible ? "·∫®n playlist" : "Hi·ªán playlist";
			};

			// Kh·ªüi ƒë·ªông trang
			modeSpan.textContent = isRandom ? "Ng·∫´u nhi√™n" : "Tu·∫ßn t·ª±";
			renderPlaylist();
			// play(currentIndex);
		</script>
	</body>
</html>
